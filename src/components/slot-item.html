<template>
  <div class="select">
    <div class="select-display">{{slot?.label || "Empty"}}</div>
    <div class="select-list">
      <ul class="uk-list">
        <li @click="updateSelection(null)">Empty</li>
        <li @click="updateSelection('__script')">Script</li>
        <template :for="options">
          <li @click="updateSelection($value.id)">{{$value.label}}</li>
        </template>
      </ul>
    </div>
    <div class="select-actions">
      <template :if="slot?.effect === '__script'">
        <div class="select-handle" @click="openEdit($event)">
          <span data-uk-icon="icon: pencil"></span>
        </div>
      </template>
      <div class="select-handle" @click="toggleDisabled($event)">
        <span :data-uk-icon="slot?.disabled ? 'eye-slash' : 'icon: eye'"></span>
      </div>
      <div class="select-handle" @click="toggleActive($event)">
        <span data-uk-icon="icon: triangle-down"></span>
      </div>
    </div>
  </div>
</template>

<script>
  class SlotList extends Component {
    constructor() {
      super();
    }

    static get observedProperties() {
      return ["idx", "options", "app", "slot"];
    }

    connected() {
      this.listen("idx", (idx) => {
        this.updateSlot();
      });
    }

    updateSlot(updates) {
      this.app.updateSlot(this.idx, updates);
      this.slot = JSON.parse(JSON.stringify(this.app.state.slots[this.idx]));
    }

    openEdit(e) {
      e.preventDefault();
      e.stopPropagation();

      let editor = document.createElement("script-editor");

      editor.save = this.editScript.bind(this);
      editor.app = this.app;
      editor.code = this.slot.script.code;
      editor.label = this.slot.script.label;

      document.body.appendChild(editor);
    }

    editScript(label, code) {
      let script = this.slot.script;

      script.label = label;
      script.code = code;

      this.updateSlot({
        script: script,
      });
    }

    toggleActive(e) {
      e.preventDefault();
      e.stopPropagation();

      this.querySelector(".select").classList.add("active");

      window.addEventListener("click", () => {
        this.querySelector(".select").classList.remove("active");
      });
    }

    toggleDisabled(e) {
      e.preventDefault();
      e.stopPropagation();

      this.updateSlot({ disabled: !this.slot.disabled });
    }

    updateSelection(id) {
      if (id === null) {
        this.app.setSlot(this.idx, null);
      } else if (id === "__script") {
        this.app.setSlot(this.idx, id);
      } else {
        this.app.setSlot(this.idx, id);
      }

      this.updateSlot();
    }
  }
</script>
